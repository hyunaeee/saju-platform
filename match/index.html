<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>운명(運命) - 사주 궁합 분석</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700&family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        .font-serif {
            font-family: 'Noto Serif KR', serif;
        }
        
        .animate-fade-in-up {
            animation: fadeInUp 0.5s ease-out forwards;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; 
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; 
        }
    </style>
</head>
<body class="bg-gray-950 text-gray-100 min-h-screen pb-20 selection:bg-amber-900 selection:text-white">

    <!-- Header -->
    <header class="bg-gray-900 border-b border-gray-800 sticky top-0 z-20 shadow-md">
        <div class="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center space-x-2">
                <div class="bg-amber-700 p-2 rounded-lg">
                    <i data-lucide="scroll" class="text-white w-5 h-5"></i>
                </div>
                <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-amber-200 to-amber-600 font-serif tracking-wider">
                    운명(運命)
                </h1>
            </div>
            <div class="text-xs text-gray-500 hidden sm:block">
                동양 철학 기반 정통 궁합 분석
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 py-8">
        <!-- Intro -->
        <div class="text-center mb-10">
            <h2 class="text-2xl sm:text-3xl font-bold mb-3">당신의 인연을 확인하세요</h2>
            <p class="text-gray-400 text-sm sm:text-base">
                사주팔자(四柱八字)에 숨겨진 기운을 분석하여<br class="sm:hidden"/> 서로의 조화와 미래를 예측합니다.
            </p>
        </div>

        <!-- Tabs -->
        <div class="flex flex-wrap justify-center gap-2 mb-8" id="tabs-container">
            <!-- Tabs will be injected by JS -->
        </div>

        <!-- Input Section -->
        <div class="grid md:grid-cols-2 gap-6 mb-8 relative">
            <!-- Connector Line for Desktop -->
            <div class="hidden md:flex absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 z-10 bg-gray-900 p-2 rounded-full border border-gray-800">
                <i data-lucide="arrow-right" class="text-gray-600"></i>
            </div>

            <!-- Person A Input -->
            <div class="bg-gray-900 p-6 rounded-2xl border border-gray-800 shadow-sm hover:border-gray-700 transition-colors">
                <h3 class="text-lg font-semibold mb-4 text-gray-200 flex items-center">
                    <span class="w-2 h-6 bg-blue-500 rounded-sm mr-2"></span>
                    본인 (甲)
                </h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">이름</label>
                        <input type="text" id="nameA" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-sm focus:outline-none focus:border-blue-500 transition-colors" placeholder="이름 입력">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">생년월일 (양력)</label>
                        <input type="date" id="dateA" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-sm focus:outline-none focus:border-blue-500 text-gray-200 placeholder-gray-500">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">태어난 시간 (선택)</label>
                            <input type="time" id="timeA" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-sm focus:outline-none focus:border-blue-500 text-gray-200">
                            <p class="text-[10px] text-gray-500 mt-1">*모르면 비워두세요</p>
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">성별</label>
                            <div class="flex bg-gray-800 rounded-lg p-1 border border-gray-700 h-[46px]">
                                <button onclick="setGender('A', 'male')" id="genderA-male" class="flex-1 rounded-md text-xs transition-colors bg-blue-600 text-white">남</button>
                                <button onclick="setGender('A', 'female')" id="genderA-female" class="flex-1 rounded-md text-xs transition-colors text-gray-400 hover:text-gray-200">여</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-6" id="sajuCardA">
                    <!-- Saju Card A Content -->
                    <div class="bg-gray-800/50 p-6 rounded-xl border border-gray-700 flex items-center justify-center h-48">
                        <p class="text-gray-500">정보를 입력해주세요</p>
                    </div>
                </div>
            </div>

            <!-- Person B Input -->
            <div class="bg-gray-900 p-6 rounded-2xl border border-gray-800 shadow-sm hover:border-gray-700 transition-colors">
                <h3 class="text-lg font-semibold mb-4 text-gray-200 flex items-center">
                    <span class="w-2 h-6 bg-pink-500 rounded-sm mr-2"></span>
                    상대방 (乙)
                </h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">이름</label>
                        <input type="text" id="nameB" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-sm focus:outline-none focus:border-pink-500 transition-colors" placeholder="상대방 이름 입력">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">생년월일 (양력)</label>
                        <input type="date" id="dateB" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-sm focus:outline-none focus:border-pink-500 text-gray-200 placeholder-gray-500">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">태어난 시간 (선택)</label>
                            <input type="time" id="timeB" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-sm focus:outline-none focus:border-pink-500 text-gray-200">
                             <p class="text-[10px] text-gray-500 mt-1">*모르면 비워두세요</p>
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">성별</label>
                            <div class="flex bg-gray-800 rounded-lg p-1 border border-gray-700 h-[46px]">
                                <button onclick="setGender('B', 'male')" id="genderB-male" class="flex-1 rounded-md text-xs transition-colors text-gray-400 hover:text-gray-200">남</button>
                                <button onclick="setGender('B', 'female')" id="genderB-female" class="flex-1 rounded-md text-xs transition-colors bg-pink-600 text-white">여</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-6" id="sajuCardB">
                    <!-- Saju Card B Content -->
                    <div class="bg-gray-800/50 p-6 rounded-xl border border-gray-700 flex items-center justify-center h-48">
                        <p class="text-gray-500">정보를 입력해주세요</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Button -->
        <div class="flex justify-center mb-12">
            <button id="analyzeBtn" onclick="handleAnalyze()" class="group relative inline-flex items-center justify-center px-8 py-4 font-bold text-white transition-all duration-200 font-serif rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 bg-amber-700 hover:bg-amber-600 focus:ring-amber-600">
                <span id="btnText" class="flex items-center">
                    <i data-lucide="sparkles" class="mr-2 w-5 h-5 group-hover:rotate-12 transition-transform"></i>
                    궁합 결과 보기
                </span>
                <span id="btnLoading" class="hidden flex items-center">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    운명을 읽는 중...
                </span>
                <div class="absolute inset-0 rounded-full ring-2 ring-white/20 group-hover:ring-white/40 transition-all"></div>
            </button>
        </div>

        <!-- Result Section -->
        <div id="resultContainer"></div>

        <!-- Info / Disclaimer -->
        <div class="mt-12 text-center text-xs text-gray-600 flex flex-col items-center gap-2">
            <i data-lucide="info" class="w-4 h-4 mb-1"></i>
            <p>본 서비스는 재미로 보는 궁합 서비스입니다.</p>
            <p>정확한 사주 분석은 출생시 분 단위와 지역 보정 등 복잡한 절차가 필요하므로,<br/> 인생의 중대사는 전문가와 상담하시는 것을 권장합니다.</p>
        </div>
    </main>

    <script>
        // --- CONSTANTS & DATA ---
        const CELESTIAL_STEMS = [
            { char: '甲', name: '갑', element: 'wood', yang: true, color: 'text-green-600', desc: '거목(巨木)과 같은 기질을 타고났습니다. 하늘을 향해 곧게 뻗어 올라가려는 상승 욕구가 강하며, 어지간한 시련에는 굽히지 않는 강직한 리더십을 지녔습니다. 매사에 솔직하고 인자하지만, 한 번 고집을 피우면 꺾기 힘든 대쪽 같은 면모가 있어 융통성이 부족하다는 평을 듣기도 합니다.' },
            { char: '乙', name: '을', element: 'wood', yang: false, color: 'text-green-500', desc: '들판에 피어난 꽃이나 덩굴 식물처럼 유연하고 생명력이 강인합니다. 겉으로는 부드럽고 연약해 보이지만, 어떤 환경에서도 살아남는 끈기와 적응력은 타의 추종을 불허합니다. 사람들과 어울리기를 좋아하고 사교적이며, 현실적인 감각이 뛰어나 실속을 잘 챙기는 편입니다.' },
            { char: '丙', name: '병', element: 'fire', yang: true, color: 'text-red-600', desc: '하늘에 떠 있는 태양처럼 밝고 정열적입니다. 숨기는 것 없이 매사를 명백하게 밝히려는 성향이 있어 뒤끝이 없고 호탕합니다. 예의와 격식을 중요시하며, 어디를 가나 주목받는 것을 즐깁니다. 다만, 성격이 급하고 다혈질적인 면이 있어 순간적으로 욱하는 기질을 다스려야 합니다.' },
            { char: '丁', name: '정', element: 'fire', yang: false, color: 'text-red-500', desc: '어둠을 밝히는 촛불이나 달빛처럼 은은하고 따뜻한 온기를 지녔습니다. 겉으로는 조용해 보이지만 내면에는 뜨거운 열정과 집념을 품고 있는 외유내강형입니다. 타인을 배려하는 희생정신과 섬세한 감수성이 발달해 있어 예술적 재능이 뛰어나지만, 때로는 감정 기복이 심해질 수 있습니다.' },
            { char: '戊', name: '무', element: 'earth', yang: true, color: 'text-yellow-600', desc: '광활한 대지나 웅장한 산처럼 묵직하고 믿음직스러우며, 포용력이 넓어 사람들을 아우르는 능력이 탁월하며, 신용과 신의를 목숨처럼 중요하게 여깁니다. 말과 행동이 진중하여 중재자 역할을 잘 수행하지만, 변화를 싫어하고 보수적인 경향이 강해 고리타분해 보일 수 있습니다.' },
            { char: '己', name: '기', element: 'earth', yang: false, color: 'text-yellow-500', desc: '만물을 길러내는 비옥한 논밭의 형상입니다. 실속 있고 현실적인 판단력이 뛰어나며, 자기 사람을 챙기는 능력이 매우 탁월합니다. 온화하고 다정다감하여 주변에 적을 만들지 않지만, 속내를 잘 드러내지 않아 의뭉스럽다는 오해를 받거나 지나친 의심으로 기회를 놓칠 때가 있습니다.' },
            { char: '庚', name: '경', element: 'metal', yang: true, color: 'text-gray-600', desc: '제련되지 않은 원석이나 거대한 바위처럼 단단하고 결단력이 있습니다. 의리와 정의감이 투철하여 불의를 보면 참지 못하고, 한 번 맺은 인연은 끝까지 지키려 합니다. 맺고 끊음이 확실하여 카리스마가 넘치지만, 타인에게 곁을 잘 주지 않는 차가운 면모나 독선적인 태도는 주의해야 합니다.' },
            { char: '辛', name: '신', element: 'metal', yang: false, color: 'text-gray-500', desc: '잘 다듬어진 보석이나 예리한 칼날처럼 섬세하고 날카롭습니다. 자존심이 매우 강하고 깔끔한 성격이라 완벽주의를 추구합니다. 감수성이 예민하고 직관력이 뛰어나지만, 그만큼 상처를 잘 받고 한 번 틀어지면 냉정하게 돌아섭니다. 자신을 빛내려는 욕구가 강해 멋쟁이가 많습니다.' },
            { char: '壬', name: '임', element: 'water', yang: true, color: 'text-blue-600', desc: '유유히 흐르는 큰 강이나 바다처럼 스케일이 크고 지혜롭습니다. 어떤 그릇에도 담길 수 있는 유연함과 임기응변 능력을 갖췄으며, 포용력이 넓어 대인 관계가 원만합니다. 하지만 속을 알 수 없는 깊음이 있어 비밀이 많아 보이거나, 한 번 화가 나면 쓰나미처럼 무섭게 돌변하기도 합니다.' },
            { char: '癸', name: '계', element: 'water', yang: false, color: 'text-blue-500', desc: '대지를 적시는 봄비나 옹달샘처럼 맑고 순수합니다. 지혜롭고 총명하며 기획력과 아이디어가 뛰어납니다. 조용히 스며드는 성격이라 적응력이 좋고 감수성이 풍부하지만, 마음이 여려 상처를 잘 받고 사소한 일에도 걱정이 많아 예민해지기 쉽습니다.' },
        ];

        const EARTHLY_BRANCHES = [
            { char: '子', name: '자', animal: '쥐', element: 'water' },
            { char: '丑', name: '축', animal: '소', element: 'earth' },
            { char: '寅', name: '인', animal: '호랑이', element: 'wood' },
            { char: '卯', name: '묘', animal: '토끼', element: 'wood' },
            { char: '辰', name: '진', animal: '용', element: 'earth' },
            { char: '巳', name: '사', animal: '뱀', element: 'fire' },
            { char: '午', name: '오', animal: '말', element: 'fire' },
            { char: '未', name: '미', animal: '양', element: 'earth' },
            { char: '申', name: '신', animal: '원숭이', element: 'metal' },
            { char: '酉', name: '유', animal: '닭', element: 'metal' },
            { char: '戌', name: '술', animal: '개', element: 'earth' },
            { char: '亥', name: '해', animal: '돼지', element: 'water' },
        ];

        const ELEMENTS = {
            wood: { name: '목(木)', color: 'bg-green-500', text: 'text-green-500' },
            fire: { name: '화(火)', color: 'bg-red-500', text: 'text-red-500' },
            earth: { name: '토(土)', color: 'bg-yellow-500', text: 'text-yellow-500' },
            metal: { name: '금(金)', color: 'bg-gray-400', text: 'text-gray-400' },
            water: { name: '수(水)', color: 'bg-blue-500', text: 'text-blue-500' },
        };

        const WONJIN_PAIRS = { '子': '未', '未': '子', '丑': '午', '午': '丑', '寅': '酉', '酉': '寅', '卯': '申', '申': '卯', '辰': '亥', '亥': '辰', '巳': '戌', '戌': '巳' };
        const HAP_PAIRS = { '子': '丑', '丑': '子', '寅': '亥', '亥': '寅', '卯': '戌', '戌': '卯', '辰': '酉', '酉': '辰', '巳': '申', '申': '巳', '午': '未', '未': '午' };
        const CHUNG_PAIRS = { '子': '午', '午': '子', '丑': '未', '未': '丑', '寅': '申', '申': '寅', '卯': '酉', '酉': '卯', '辰': '戌', '戌': '辰', '巳': '亥', '亥': '巳' };

        // --- STATE ---
        let state = {
            activeTab: 'couple',
            personA: { name: '', date: '', time: '', gender: 'male' },
            personB: { name: '', date: '', time: '', gender: 'female' },
            result: null
        };

        // --- TABS DATA ---
        const tabs = [
            { id: 'couple', label: '연인 궁합', icon: 'heart', color: 'text-pink-500' },
            { id: 'friend', label: '친구 궁합', icon: 'users', color: 'text-green-500' },
            { id: 'business', label: '동업 궁합', icon: 'briefcase', color: 'text-blue-500' },
            { id: 'bad', label: '악연 확인', icon: 'alert-triangle', color: 'text-red-500' },
        ];

        // --- LOGIC FUNCTIONS ---
        function calculateSaju(dateStr, timeStr) {
            if (!dateStr) return null;
            const date = new Date(dateStr);
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            
            // 근사치 알고리즘 (Demo용)
            // 년주
            const yearStemIndex = (year - 4) % 10;
            const yearBranchIndex = (year - 4) % 12;

            // 월주
            const monthStemBase = (yearStemIndex % 5) * 2; 
            const monthStemIndex = (monthStemBase + (month - 1) + 2) % 10; 
            const monthBranchIndex = (month + 1) % 12; 

            // 일주 (1900.01.01 기준 근사값)
            const baseDate = new Date('1900-01-01');
            const diffTime = Math.abs(date - baseDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            const dayStemIndex = (diffDays + 0) % 10; 
            const dayBranchIndex = (diffDays + 10) % 12;

            // 시주 계산 (시간이 있을 경우)
            let timePillar = null;
            if (timeStr) {
                const [hours, minutes] = timeStr.split(':').map(Number);
                // 한국 표준시 보정 (30분)
                // 23:30 ~ 01:29 : 자시 (0)
                // 01:30 ~ 03:29 : 축시 (1)
                // ...
                // 분으로 환산: 자시 기준점은 23*60+30 = 1410분
                const totalMins = hours * 60 + minutes;
                let timeBranchIndex;
                
                if (totalMins >= 1410 || totalMins < 90) { // 23:30 ~ 01:30 (다음날 01:29까지)
                    timeBranchIndex = 0; // 자
                } else {
                    // (총분 - 90분) / 120분(2시간)
                    // 예: 01:30 (90분) -> (90-90)/120 = 0 -> 1을 더해야 함? 
                    // 자시가 0이므로, 01:30부터는 축시(1)
                    timeBranchIndex = Math.floor((totalMins - 90) / 120) + 1;
                }
                
                // 시두법(時頭法): 일간을 기준으로 시간을 구함
                // 갑기합화토 -> 갑,기 일간은 갑자시부터 시작 (0)
                // 을경합화금 -> 을,경 일간은 병자시부터 시작 (2)
                // 병신합화수 -> 병,신 일간은 무자시부터 시작 (4)
                // 정임합화목 -> 정,임 일간은 경자시부터 시작 (6)
                // 무계합화화 -> 무,계 일간은 임자시부터 시작 (8)
                const dayStemIdx = dayStemIndex; // 0~9
                const startStemIndex = (dayStemIdx % 5) * 2;
                const timeStemIndex = (startStemIndex + timeBranchIndex) % 10;

                timePillar = {
                    stem: CELESTIAL_STEMS[timeStemIndex],
                    branch: EARTHLY_BRANCHES[timeBranchIndex]
                };
            }

            return {
                year: { stem: CELESTIAL_STEMS[yearStemIndex], branch: EARTHLY_BRANCHES[yearBranchIndex] },
                month: { stem: CELESTIAL_STEMS[monthStemIndex], branch: EARTHLY_BRANCHES[monthBranchIndex] },
                day: { stem: CELESTIAL_STEMS[dayStemIndex], branch: EARTHLY_BRANCHES[dayBranchIndex] }, 
                time: timePillar
            };
        }

        function analyzeElements(saju) {
            const counts = { wood: 0, fire: 0, earth: 0, metal: 0, water: 0 };
            if (!saju) return counts;
            
            // 년월일
            ['year', 'month', 'day'].forEach(pillar => {
                counts[saju[pillar].stem.element]++;
                counts[saju[pillar].branch.element]++;
            });

            // 시주가 있으면 포함
            if (saju.time) {
                counts[saju.time.stem.element]++;
                counts[saju.time.branch.element]++;
            }

            return counts;
        }

        function calculateCompatibility(sajuA, sajuB, type) {
            let score = 50; 
            let analysis = [];
            let keywords = [];

            const stemA = sajuA.day.stem;
            const stemB = sajuB.day.stem;
            const branchA = sajuA.day.branch;
            const branchB = sajuB.day.branch;
            
            const generatingMap = { wood: 'fire', fire: 'earth', earth: 'metal', metal: 'water', water: 'wood' };
            const controllingMap = { wood: 'earth', earth: 'water', water: 'fire', fire: 'metal', metal: 'wood' };
            
            let stemAnalysis = "";
            if (generatingMap[stemA.element] === stemB.element) {
                score += 15;
                stemAnalysis = `[본인이 상대방을 돕는 '상생(相生)'의 관계]\n\n오행의 흐름상 본인(${stemA.name})의 기운이 자연스럽게 상대방(${stemB.name})에게 흘러가 도움을 주는 형국입니다. 마치 나무가 불을 피울 수 있도록 자신을 태워 돕거나, 물이 나무를 자라게 하는 것과 같습니다. \n\n당신은 상대방을 보면 무언가 챙겨주고 싶고, 돕고 싶은 마음이 저절로 생길 것입니다. 상대방은 당신 덕분에 심리적인 안정감을 얻고, 당신을 든든한 후원자로 생각합니다. 헌신적인 사랑이지만, 일방적인 희생이 되지 않도록 자신의 에너지도 관리하는 지혜가 필요합니다.`;
                if(type !== 'bad') keywords.push("헌신과 배려", "아낌없는 나무");
            } else if (generatingMap[stemB.element] === stemA.element) {
                score += 15;
                stemAnalysis = `[상대방이 본인을 돕는 '수혜(受惠)'의 관계]\n\n상대방(${stemB.name})의 기운이 본인(${stemA.name})을 생(生)해주는, 즉 당신이 사랑과 후원을 받는 관계입니다. 상대방은 당신이 무엇을 필요로 하는지 본능적으로 알고 채워주려 노력할 것입니다.\n\n힘든 일이 있을 때 상대방은 당신에게 가장 큰 위로이자 피난처가 되어줍니다. 당신이 성장하고 발전하는 데 있어 상대방은 밑거름과 같은 역할을 자처합니다. 받는 것에 익숙해지기보다 고마움을 표현한다면 이 관계는 더욱 견고해질 것입니다.`;
                if(type !== 'bad') keywords.push("사랑받는 운명", "든든한 배경");
            } else if (stemA.element === stemB.element) {
                score += 10;
                stemAnalysis = `[같은 곳을 바라보는 '비견(比肩)'의 관계]\n\n두 분은 같은 오행(${ELEMENTS[stemA.element].name})을 공유하고 있어, 마치 오래된 친구처럼 편안하고 통하는 부분이 많습니다. 가치관, 취미, 대화 코드가 잘 맞아 처음 만나도 낯설지 않았을 것입니다.\n\n경쟁자이자 동반자로서 서로에게 좋은 자극이 됩니다. 하지만 서로 너무 잘 알기에 자존심 싸움을 하게 되면 양보 없는 대립으로 이어질 수 있습니다. '친할수록 예의를 지켜라'는 말을 명심한다면 평생을 함께할 동반자가 될 것입니다.`;
                if(type !== 'bad') keywords.push("소울메이트", "친구 같은 연인");
            } else if (controllingMap[stemA.element] === stemB.element) {
                score -= 5;
                stemAnalysis = `[본인이 주도권을 쥐는 '극(剋)'의 관계]\n\n본인(${stemA.name})이 상대방(${stemB.name})을 제어하고 다듬으려는 기운이 강합니다. 당신의 리더십과 결정이 관계를 이끌어가며, 상대방은 당신의 의견을 따르는 편입니다.\n\n적당한 통제는 상대방을 올바른 길로 인도하지만, 지나치면 상대방이 압박감을 느끼고 위축될 수 있습니다. '내가 옳다'는 생각보다 상대방의 입장을 한 번 더 헤아려주는 배려가 관계 유지의 핵심입니다.`;
                keywords.push("주도권", "리더십");
            } else {
                score -= 5;
                stemAnalysis = `[상대방에게 압박을 받는 '피극(被剋)'의 관계]\n\n상대방(${stemB.name})이 본인(${stemA.name})을 제어하는 형국입니다. 당신은 상대방 앞에서 묘한 긴장감을 느끼거나, 상대방의 말에 쉽게 반박하지 못하는 어려움을 느낄 수 있습니다.\n\n이는 스트레스가 될 수도 있지만, 반대로 당신의 흐트러진 모습을 잡아주고 성장시키는 자극제가 되기도 합니다. 상대방의 조언을 잔소리가 아닌 쓴 약으로 받아들인다면, 당신을 더욱 단단하게 만들어줄 귀한 인연입니다.`;
                keywords.push("긴장감", "성장의 자극");
            }
            
            if (type !== 'bad') analysis.push({ title: "정신적 조화 (천간 분석)", content: stemAnalysis });

            let branchAnalysis = "";
            if (HAP_PAIRS[branchA.char] === branchB.char) {
                score += 20;
                branchAnalysis = `[하늘이 맺어준 최상의 조화, '육합(六合)']\n\n두 분의 지지(${branchA.char}-${branchB.char})에 합이 들었습니다. 이는 겉으로 보이는 조건보다 내면의 끌림이 강력함을 의미합니다. 서로 떨어져 있으면 사무치게 보고 싶고, 함께 있으면 비로소 완성된 듯한 안정을 느낍니다.\n\n현실적인 문제 해결 능력이나 경제적 관념, 그리고 부부 사이의 은밀한 속궁합까지 매우 조화롭습니다. 말하지 않아도 서로의 마음을 읽어내는 텔레파시가 통하는 사이로, 위기가 닥쳐도 두 사람이 힘을 합치면 쉽게 극복할 수 있는 천생연분입니다.`;
                if(type !== 'bad') keywords.push("찰떡궁합", "운명적 끌림");
            } else if (WONJIN_PAIRS[branchA.char] === branchB.char) {
                score -= 20;
                branchAnalysis = `[이유 없는 미움과 애증, '원진살(怨嗔煞)']\n\n원진살(${branchA.animal}-${branchB.animal})이 작용하고 있어 주의가 필요합니다. 이는 '사랑하면서도 미워하고, 미워하면서도 헤어지지 못하는' 애증의 관계를 만들기 쉽습니다. 특별한 이유 없이 상대방의 말투나 행동이 거슬리거나, 사소한 오해가 걷잡을 수 없는 큰 싸움으로 번지기도 합니다.\n\n하지만 원진살이 있다고 무조건 나쁜 것은 아닙니다. 서로의 다름을 인정하고, 집착을 내려놓으며 적당한 거리를 유지할 때 오히려 일반적인 커플보다 훨씬 깊고 끈끈한 예술적 교감을 나눌 수도 있습니다.`;
                keywords.push("원진살(주의)", "애증의 관계");
            } else if (CHUNG_PAIRS[branchA.char] === branchB.char) {
                score -= 10;
                branchAnalysis = `[정면으로 부딪히는 변화의 기운, '충( 沖)']\n\n지지 충(${branchA.char}-${branchB.char}) 관계는 서로 정반대의 성향이 만나 강하게 부딪히는 형국입니다. 생활 습관, 식성, 문제를 해결하는 방식 등 사소한 것에서부터 충돌이 잦을 수 있습니다.\n\n그러나 이 충돌은 '파괴'만을 의미하지 않습니다. 고여있는 물을 흐르게 하듯, 서로에게 신선한 충격을 주어 지루할 틈 없는 역동적인 관계를 만듭니다. '왜 저럴까?'라고 생각하기보다 '저런 관점도 있구나'라고 받아들인다면, 서로의 단점을 완벽하게 보완하는 퍼즐 조각이 될 것입니다.`;
                keywords.push("다름의 미학", "티격태격");
            } else {
                score += 5;
                branchAnalysis = `[물 흐르듯 편안한 '평온'의 관계]\n\n특별한 합이나 충이 없이 무난하고 안정적인 관계입니다. 불꽃 튀는 강렬함은 덜할 수 있지만, 반대로 감정 소모가 심한 다툼도 적습니다. 마치 잔잔한 호수처럼 서로에게 편안한 휴식처가 되어줍니다.\n\n자극적인 사건 없이도 일상을 공유하며 소소한 행복을 쌓아가는 관계입니다. 오랜 친구에서 연인으로, 연인에서 가족으로 발전하기에 가장 이상적인 형태라 할 수 있습니다.`;
                keywords.push("안정적", "편안함");
            }

            if (type !== 'bad') analysis.push({ title: "현실적 조화 (지지/속궁합 분석)", content: branchAnalysis });

            let typeAdvice = "";
            const elementsA = analyzeElements(sajuA);
            const elementsB = analyzeElements(sajuB);
            
            if (type === 'bad') {
                score = Math.max(0, Math.min(100, 100 - score));
                let badTitle = "", badContent = "", solution = "";

                if (score >= 80) {
                    badTitle = "서로를 파괴하는 '위험수위(危險水位)'의 관계";
                    badContent = "냉정하게 말씀드리면, 두 분의 만남은 서로의 인생에 득보다 실이 많은 '상극(相剋)'의 인연에 가깝습니다. 함께 있으면 일이 꼬이거나, 정신적으로 피폐해지거나, 심지어 건강이나 재물운까지 나빠지는 현상이 나타날 수 있습니다. 마치 물과 기름처럼 본질적으로 섞일 수 없는 기운들이 충돌하고 있어, 노력만으로는 극복하기 힘든 근본적인 불협화음이 존재합니다.";
                    solution = "가장 좋은 해법은 '물리적, 심리적 거리두기'입니다. \n\n1. 기대치를 '0'으로 낮추세요. 상대방에게 감정적인 위로를 바라지 말고, 사무적인 태도를 유지하는 것이 상처받지 않는 길입니다.\n2. 논쟁을 피하세요. 대화로 풀려다가 오히려 더 큰 화를 부를 수 있습니다. 갈등 상황에서는 침묵하거나 자리를 피하는 것이 지혜입니다.\n3. 만약 헤어질 수 없는 관계(가족, 직장)라면, 주말부부처럼 떨어져 지내는 시간을 최대한 확보하거나 각자의 취미 생활에 몰두하여 서로 간섭하는 시간을 최소화해야 합니다.";
                    keywords.push("경고", "거리두기 필수");
                } else if (score >= 60) {
                    badTitle = "끊임없이 부딪히는 질긴 '애증(愛憎)'의 고리";
                    badContent = "원진살이나 충이 강하게 작용하여, 좋았다가도 순식간에 원수처럼 돌변할 수 있는 살얼음판 같은 관계입니다. 서로가 서로에게 '업보' 처럼 느껴질 수 있습니다. 헤어지려고 하면 이상하게 다시 붙잡게 되고, 만나면 다시 싸우는 소모적인 패턴이 반복될 가능성이 큽니다. 서로의 자존심을 건드리는 말들이 비수처럼 꽂혀 잊혀지지 않는 상처를 남깁니다.";
                    solution = "이 관계를 유지하려면 '다름을 인정하는 수행'이 필요합니다.\n\n1. 상대방을 '외계인'이라고 생각하세요. 나와는 사고 회로가 완전히 다른 존재임을 인정하고 분석하려 들지 마세요.\n2. '투명 인간' 요법을 쓰세요. 상대방이 감정적으로 폭발할 때는 맞대응하지 말고, 태풍이 지나가듯 반응을 보이지 않고 흘려버리는 것이 상책입니다.\n3. 함께하는 시간보다는 각자의 독립적인 시간을 존중해야 관계가 숨을 쉴 수 있습니다.";
                    keywords.push("고난의 연속", "인내심 테스트");
                } else if (score >= 40) {
                    badTitle = "약간의 마찰음이 들리는 '보통'의 인연";
                    badContent = "악연이라 부르기엔 무리가 있습니다. 가끔 의견 충돌이나 성격 차이로 인한 다툼이 있겠지만, 이는 건강한 관계라면 어디에나 존재하는 자연스러운 현상입니다. 다만, 특정 시기(운세가 나쁠 때)에 예민해져서 싸움이 커질 수 있으니 그 점만 주의하면 됩니다.";
                    solution = "서로의 자존심(역린)만 건드리지 않는다면 무탈하게 지낼 수 있습니다. \n상대방의 단점을 지적하기보다, '나는 이런 점이 서운해'라고 내 감정을 주어로 말하는 'I-Message' 화법을 연습해보세요. 작은 배려만으로도 금방 회복될 수 있는 관계입니다.";
                    keywords.push("노력하면 극복", "평범함");
                } else {
                    badTitle = "악연이 아닌 귀한 '귀인(貴人)'입니다";
                    badContent = "걱정하지 마세요. 악연 지수가 매우 낮습니다. 오히려 서로에게 도움이 되고 기운을 북돋아주는 좋은 인연에 가깝습니다. 전생에 덕을 많이 쌓아야 만날 수 있다는 길연(吉緣)입니다. 서로가 서로에게 행운의 부적과도 같은 존재입니다.";
                    solution = "악연 테스트를 할 필요가 없을 정도로 좋습니다. 다만, '친한 사이일수록 막 대하기 쉽다'는 점만 경계하세요. 너무 편안해서 무례해지지 않도록, 기본적인 예의와 감사를 표현한다면 평생을 함께할 아름다운 인연이 될 것입니다.";
                    keywords.push("천생연분", "안심하세요");
                }

                analysis = [
                    { title: "악연 정밀 진단 (관계의 위험도)", content: badContent },
                    { title: "살(煞)을 피하는 실전 처방전", content: solution },
                    { title: "참고: 두 사람의 기운 분석", content: stemAnalysis + "\n\n" + branchAnalysis }
                ];
                typeAdvice = badTitle;
            } else {
                score = Math.min(100, Math.max(0, score));
                if (type === 'couple') {
                    const lackingA = Object.keys(elementsA).find(k => elementsA[k] === 0);
                    if (lackingA && elementsB[lackingA] > 1) {
                        score += 10;
                        typeAdvice = `[부족함을 채워주는 완벽한 보완]\n특히 좋습니다! 본인 사주에서 부족하거나 없는 기운인 '${ELEMENTS[lackingA].name}'을 상대방이 넉넉하게 가지고 있습니다.\n\n이는 상대방이 당신의 결핍을 채워주고 인생의 균형을 맞춰주는 '귀인'임을 의미합니다. 당신이 혼자서는 해결하기 힘든 문제들을 상대방의 도움으로 쉽게 풀어나갈 수 있습니다. 서로가 서로에게 꼭 필요한 존재가 되는 이상적인 결합입니다.`;
                        keywords.push("상호보완", "천생연분");
                    } else {
                        typeAdvice = `[서로의 노력이 꽃피우는 사랑]\n연인 관계에서는 점수보다 서로의 감정선을 이해하는 노력이 중요합니다. \n\n점수가 높다면 결혼이나 장기적인 미래를 계획해보셔도 좋습니다. 만약 점수가 조금 낮다면, 이는 '안 맞는 것'이 아니라 '서로 다른 매력'을 가진 것입니다. 나와 다른 상대방의 세계를 탐험한다고 생각하고 맞춰가는 과정을 즐긴다면, 그 어떤 궁합보다 단단한 사랑을 만들 수 있습니다.`;
                    }
                } else if (type === 'business') {
                    if (stemA.yang !== stemB.yang) {
                        score += 10;
                        typeAdvice = `[음양의 조화가 완벽한 파트너]\n사업적 궁합이 매우 훌륭합니다. 한 명이 대외적인 영업이나 확장을 담당하면(양), 다른 한 명은 내부 관리나 실무를 꼼꼼하게 챙기는(음) 역할 분담이 자연스럽게 이루어집니다.\n\n서로의 영역을 침범하지 않으면서 최대의 시너지를 낼 수 있는 '환상의 복식조'와 같습니다.`;
                        keywords.push("환상의 파트너", "시너지 폭발");
                    } else {
                        typeAdvice = `[비슷한 성향의 동반자]\n생각과 속도가 비슷하여 의사결정이 빠르고 추진력이 좋습니다. 하지만 두 사람 모두 놓치는 사각지대가 발생할 수 있습니다.\n\n동업을 하신다면 반드시 제3자의 객관적인 조언을 듣거나, 계약서 및 역할 분담을 문서화하여 명확히 해두는 것이 장기적인 성공의 열쇠입니다.`;
                    }
                } else if (type === 'friend') {
                    if (stemA.element === stemB.element) {
                        typeAdvice = `[평생을 함께할 지음(知音)]\n말하지 않아도 마음이 통하는 '베스트 프렌드' 감입니다. 서로가 서로의 거울과 같아서, 함께 있는 것만으로도 위로가 되고 힘이 됩니다. 인생의 희로애락을 끝까지 함께할 소중한 벗이니 인연을 귀하게 여기세요.`;
                    } else {
                        typeAdvice = `[새로운 세상을 열어주는 친구]\n나와는 다른 매력과 재능을 가진 친구입니다. 내가 가보지 못한 길, 내가 생각하지 못한 관점을 제시해주는 좋은 자극제가 됩니다. 함께 새로운 취미를 배우거나 여행을 떠나면 서로의 세계를 넓혀주는 멋진 우정을 쌓을 수 있습니다.`;
                    }
                }
                analysis.push({ title: "관계에 대한 도사의 조언", content: typeAdvice });
            }

            score = Math.min(100, Math.max(0, score));
            return { score, analysis, keywords, type, typeAdvice, personalities: { a: stemA.desc, b: stemB.desc } };
        }

        // --- UI FUNCTIONS ---
        
        function renderTabs() {
            const container = document.getElementById('tabs-container');
            container.innerHTML = tabs.map(tab => {
                const isActive = state.activeTab === tab.id;
                const activeClass = isActive 
                    ? `bg-gray-800 border-amber-600 text-amber-500 shadow-[0_0_15px_rgba(217,119,6,0.2)]` 
                    : `bg-gray-900 border-gray-800 text-gray-400 hover:bg-gray-800`;
                const iconColor = isActive ? tab.color : '';
                return `
                    <button onclick="setTab('${tab.id}')" class="flex items-center space-x-2 px-4 py-3 rounded-full transition-all duration-300 border ${activeClass}">
                        <i data-lucide="${tab.icon}" class="${iconColor} w-[18px] h-[18px]"></i>
                        <span class="font-medium text-sm">${tab.label}</span>
                    </button>
                `;
            }).join('');
            lucide.createIcons();
            
            // Update button styles based on tab
            const btn = document.getElementById('analyzeBtn');
            const btnText = document.getElementById('btnText');
            if (state.activeTab === 'bad') {
                btn.className = "group relative inline-flex items-center justify-center px-8 py-4 font-bold text-white transition-all duration-200 font-serif rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 bg-red-900 hover:bg-red-800 focus:ring-red-700";
                btnText.innerHTML = `<i data-lucide="sparkles" class="mr-2 w-5 h-5 group-hover:rotate-12 transition-transform"></i> 악연 지수 확인하기`;
            } else {
                btn.className = "group relative inline-flex items-center justify-center px-8 py-4 font-bold text-white transition-all duration-200 font-serif rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 bg-amber-700 hover:bg-amber-600 focus:ring-amber-600";
                btnText.innerHTML = `<i data-lucide="sparkles" class="mr-2 w-5 h-5 group-hover:rotate-12 transition-transform"></i> 궁합 결과 보기`;
            }
            lucide.createIcons();
        }

        function setTab(tabId) {
            state.activeTab = tabId;
            state.result = null;
            document.getElementById('resultContainer').innerHTML = '';
            renderTabs();
        }

        function setGender(person, gender) {
            if (person === 'A') {
                state.personA.gender = gender;
                document.getElementById('genderA-male').className = gender === 'male' ? "flex-1 rounded-md text-xs transition-colors bg-blue-600 text-white" : "flex-1 rounded-md text-xs transition-colors text-gray-400 hover:text-gray-200";
                document.getElementById('genderA-female').className = gender === 'female' ? "flex-1 rounded-md text-xs transition-colors bg-pink-600 text-white" : "flex-1 rounded-md text-xs transition-colors text-gray-400 hover:text-gray-200";
            } else {
                state.personB.gender = gender;
                document.getElementById('genderB-male').className = gender === 'male' ? "flex-1 rounded-md text-xs transition-colors bg-blue-600 text-white" : "flex-1 rounded-md text-xs transition-colors text-gray-400 hover:text-gray-200";
                document.getElementById('genderB-female').className = gender === 'female' ? "flex-1 rounded-md text-xs transition-colors bg-pink-600 text-white" : "flex-1 rounded-md text-xs transition-colors text-gray-400 hover:text-gray-200";
            }
        }

        function updateSajuCard(personType) {
            const dateInput = document.getElementById(`date${personType}`).value;
            const timeInput = document.getElementById(`time${personType}`).value;
            const nameInput = document.getElementById(`name${personType}`).value;
            const cardContainer = document.getElementById(`sajuCard${personType}`);
            
            const saju = calculateSaju(dateInput, timeInput);
            
            if (!saju) {
                cardContainer.innerHTML = `<div class="bg-gray-800/50 p-6 rounded-xl border border-gray-700 flex items-center justify-center h-48"><p class="text-gray-500">정보를 입력해주세요</p></div>`;
                return;
            }

            const elements = analyzeElements(saju);
            const total = Object.values(elements).reduce((a, b) => a + b, 0);
            
            // Build Elements Bar
            let barHTML = '';
            for (const [el, count] of Object.entries(elements)) {
                if (count > 0) {
                    const width = (count / total) * 100;
                    barHTML += `<div style="width: ${width}%" class="${ELEMENTS[el].color} h-full" title="${ELEMENTS[el].name}: ${count}개"></div>`;
                }
            }

            // 시주 표시 로직 (값이 없으면 ? 표시)
            let timePillarHTML = '';
            if (saju.time) {
                timePillarHTML = `
                    <div class="flex flex-col w-12 h-16 bg-gray-800 border border-gray-600 rounded overflow-hidden">
                        <div class="h-1/2 flex items-center justify-center font-serif text-lg ${saju.time.stem.color}">${saju.time.stem.char}</div>
                        <div class="h-1/2 flex items-center justify-center font-serif text-lg border-t border-gray-700 text-gray-300">${saju.time.branch.char}</div>
                    </div>
                `;
            } else {
                timePillarHTML = `
                    <div class="w-12 h-16 bg-gray-800 border border-gray-600 rounded flex items-center justify-center text-gray-600 text-xs">알수<br>없음</div>
                `;
            }

            cardContainer.innerHTML = `
                <div class="bg-gradient-to-br from-gray-800 to-gray-900 p-6 rounded-xl border border-gray-700 shadow-lg relative overflow-hidden group hover:border-amber-700/50 transition-colors">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                         <i data-lucide="sparkles" class="w-12 h-12"></i>
                    </div>
                    <h3 class="text-amber-500 font-bold mb-1 text-lg flex items-center gap-2">
                        ${nameInput || (personType === 'A' ? '본인' : '상대방')}님의 사주
                        <span class="text-xs font-normal text-gray-500 border border-gray-700 rounded px-2 py-0.5">
                            ${saju.day.stem.name}일주 (${saju.day.stem.yang ? '양' : '음'}${ELEMENTS[saju.day.stem.element].name})
                        </span>
                    </h3>
                    <p class="text-gray-400 text-xs mb-4 min-h-[60px] leading-relaxed line-clamp-3">${saju.day.stem.desc}</p>
                    
                    <div class="grid grid-cols-4 gap-2 mb-6 text-center">
                        <div class="flex flex-col items-center">
                            <span class="text-gray-500 text-xs mb-1">시주</span>
                            ${timePillarHTML}
                        </div>
                        <div class="flex flex-col items-center transform scale-110">
                            <span class="text-amber-500 text-xs mb-1 font-bold">일주</span>
                            <div class="flex flex-col w-12 h-16 bg-gray-700 border border-amber-500 rounded overflow-hidden shadow-inner">
                                <div class="h-1/2 flex items-center justify-center font-serif text-xl ${saju.day.stem.color} bg-gray-900">${saju.day.stem.char}</div>
                                <div class="h-1/2 flex items-center justify-center font-serif text-xl border-t border-gray-600 ${ELEMENTS[saju.day.branch.element].text} bg-gray-800">${saju.day.branch.char}</div>
                            </div>
                        </div>
                        <div class="flex flex-col items-center opacity-75">
                             <span class="text-gray-500 text-xs mb-1">월주</span>
                            <div class="flex flex-col w-12 h-16 bg-gray-800 border border-gray-600 rounded overflow-hidden">
                                <div class="h-1/2 flex items-center justify-center font-serif text-lg ${saju.month.stem.color}">${saju.month.stem.char}</div>
                                <div class="h-1/2 flex items-center justify-center font-serif text-lg border-t border-gray-700 text-gray-300">${saju.month.branch.char}</div>
                            </div>
                        </div>
                         <div class="flex flex-col items-center opacity-50">
                            <span class="text-gray-500 text-xs mb-1">년주</span>
                            <div class="flex flex-col w-12 h-16 bg-gray-800 border border-gray-600 rounded overflow-hidden">
                                <div class="h-1/2 flex items-center justify-center font-serif text-lg ${saju.year.stem.color}">${saju.year.stem.char}</div>
                                <div class="h-1/2 flex items-center justify-center font-serif text-lg border-t border-gray-700 text-gray-300">${saju.year.branch.char}</div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <div class="flex justify-between text-xs text-gray-400 mb-1">
                            <span>오행 분포</span>
                        </div>
                        <div class="flex h-4 w-full rounded-full overflow-hidden mt-2 bg-gray-800 border border-gray-700">
                            ${barHTML}
                        </div>
                        <div class="flex justify-between mt-1 text-[10px] text-gray-500 px-1">
                            <span>목</span><span>화</span><span>토</span><span>금</span><span>수</span>
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        function handleAnalyze() {
            const dateA = document.getElementById('dateA').value;
            const timeA = document.getElementById('timeA').value;
            const dateB = document.getElementById('dateB').value;
            const timeB = document.getElementById('timeB').value;
            const nameA = document.getElementById('nameA').value;
            const nameB = document.getElementById('nameB').value;

            state.personA.date = dateA;
            state.personA.time = timeA;
            state.personA.name = nameA;
            state.personB.date = dateB;
            state.personB.time = timeB;
            state.personB.name = nameB;

            if (!dateA || !dateB) {
                alert("두 분의 생년월일을 모두 입력해주세요.");
                return;
            }

            // Loading state
            const btn = document.getElementById('analyzeBtn');
            const btnText = document.getElementById('btnText');
            const btnLoading = document.getElementById('btnLoading');
            btn.disabled = true;
            btn.classList.add('opacity-75', 'cursor-not-allowed');
            btnText.classList.add('hidden');
            btnLoading.classList.remove('hidden');

            // Simulate calculation
            setTimeout(() => {
                const sajuA = calculateSaju(dateA, timeA);
                const sajuB = calculateSaju(dateB, timeB);
                const result = calculateCompatibility(sajuA, sajuB, state.activeTab);
                
                state.result = result;
                renderResult(result);

                // Reset button
                btn.disabled = false;
                btn.classList.remove('opacity-75', 'cursor-not-allowed');
                btnText.classList.remove('hidden');
                btnLoading.classList.add('hidden');
            }, 1500);
        }

        function renderResult(result) {
            const container = document.getElementById('resultContainer');
            const isBadMode = result.type === 'bad';
            
            const borderColor = isBadMode ? 'border-red-900/50' : 'border-gray-800';
            const headerBg = isBadMode ? 'bg-gradient-to-b from-red-950 to-gray-900 border-red-900/30' : 'bg-gradient-to-b from-gray-800 to-gray-900 border-gray-800';
            const progressColor = isBadMode ? 'via-red-600' : 'via-amber-500';
            const titleColor = isBadMode ? 'text-red-500' : 'text-amber-500';
            const scoreColor = isBadMode && result.score > 60 ? 'text-red-500' : 'text-white';
            const badgeClass = isBadMode ? 'bg-red-950/30 border-red-900 text-red-300' : 'bg-gray-800 border-gray-700 text-gray-300';
            
            let badFateText = '';
            if (isBadMode) {
                if (result.score >= 80) badFateText = '<span class="text-red-500">매우 위험 (상극)</span>';
                else if (result.score >= 40) badFateText = '<span class="text-yellow-500">주의 필요</span>';
                else badFateText = '<span class="text-green-500">안심 (좋은 인연)</span>';
            }

            let personalitySection = '';
            if (!isBadMode) {
                personalitySection = `
                <div class="bg-gray-800/50 rounded-xl p-5 border border-gray-700 mb-6">
                    <h5 class="text-sm font-bold text-gray-300 mb-3 flex items-center">
                        <i data-lucide="users" class="w-4 h-4 mr-2 text-amber-500"></i>
                        타고난 성향 (일주 분석)
                    </h5>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div class="bg-gray-900/50 p-3 rounded-lg border border-gray-800">
                             <span class="text-xs text-blue-400 font-bold block mb-1">본인 (${state.personA.name || '본인'})</span>
                             <p class="text-sm text-gray-300 leading-relaxed whitespace-pre-line">${result.personalities.a}</p>
                        </div>
                        <div class="bg-gray-900/50 p-3 rounded-lg border border-gray-800">
                             <span class="text-xs text-pink-400 font-bold block mb-1">상대방 (${state.personB.name || '상대방'})</span>
                             <p class="text-sm text-gray-300 leading-relaxed whitespace-pre-line">${result.personalities.b}</p>
                        </div>
                    </div>
                 </div>`;
            }

            let adviceSection = '';
            if (!isBadMode) {
                let adviceText = '';
                 if (result.score > 80) adviceText = "하늘이 맺어준 귀한 인연입니다. 두 사람의 기운이 만나 서로를 더욱 밝게 비추니, 함께하는 길이 꽃길과 같습니다.\n작은 다툼은 서로를 이해하는 과정일 뿐, 두 분의 깊은 인연을 끊을 수 없습니다. 서로를 믿고 의지하며 아름다운 미래를 그려나가시길 바랍니다.";
                 else if (result.score > 50) adviceText = "서로 다른 색깔을 지녔지만, 그 다름이 오히려 서로에게 매력이 되는 관계입니다. \n나와 다르다고 해서 틀린 것이 아닙니다. 상대방을 나의 기준에 맞추려 하지 않고 있는 그대로 인정해줄 때, 두 분의 관계는 비로소 완벽한 조화를 이루게 될 것입니다.";
                 else adviceText = "관계에 있어 조금 더 세심한 노력이 필요한 시기입니다. 하지만 걱정하지 마세요. 궁합은 고정된 운명이 아니라 서로를 이해하기 위한 지도일 뿐입니다.\n서로의 차이를 이해하고 한 걸음씩 맞춰가려는 노력이 있다면, 오히려 흉이 길로 변하여 그 어떤 커플보다 단단한 사랑을 하게 될 것입니다.";

                adviceSection = `
                <div class="mt-8 bg-gradient-to-r from-amber-950/40 to-gray-900 border border-amber-900/50 p-6 rounded-xl">
                    <h5 class="text-amber-500 font-bold mb-2 flex items-center text-sm">
                        <i data-lucide="sun" class="w-4 h-4 mr-2"></i>
                        도사님의 한마디
                    </h5>
                    <p class="text-amber-100/80 text-sm leading-relaxed whitespace-pre-line">${adviceText}</p>
                </div>`;
            }

            const analysisItems = result.analysis.map(item => `
                <div class="rounded-xl p-5 border transition-colors ${isBadMode ? 'bg-red-950/10 border-red-900/30' : 'bg-gray-800/30 border-gray-700/50 hover:border-gray-600'} mb-4">
                    <h5 class="${isBadMode ? 'text-red-400' : 'text-amber-500'} font-bold mb-2 flex items-center text-base">
                       <i data-lucide="book-open" class="w-4 h-4 mr-2 opacity-70"></i>
                       ${item.title}
                    </h5>
                    <p class="text-gray-300 leading-relaxed text-sm sm:text-base whitespace-pre-line">${item.content}</p>
                </div>
            `).join('');

            const iconName = isBadMode ? 'shield-alert' : 'moon';

            container.innerHTML = `
            <div class="animate-fade-in-up bg-gray-900 rounded-3xl overflow-hidden border shadow-2xl ${borderColor}">
                <!-- Score Header -->
                <div class="p-8 text-center relative border-b ${headerBg}">
                   <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent to-transparent opacity-50 ${progressColor}"></div>
                   <h3 class="${titleColor} font-medium mb-2 tracking-widest text-sm uppercase">
                       ${isBadMode ? 'Bad Fate Index (악연 지수)' : 'Total Compatibility (궁합 점수)'}
                   </h3>
                   <div class="text-6xl font-serif font-bold ${scoreColor} mb-2 flex items-center justify-center gap-2">
                     ${result.score}
                     <span class="text-2xl text-gray-500 font-sans font-normal self-end mb-2">점</span>
                   </div>
                   ${isBadMode ? `<div class="mt-2 text-sm font-bold text-gray-400">${badFateText}</div>` : ''}
                   <div class="flex justify-center gap-2 mt-4 flex-wrap">
                     ${result.keywords.map(k => `<span class="px-3 py-1 text-xs rounded-full border ${badgeClass}">#${k}</span>`).join('')}
                   </div>
                </div>

                <!-- Analysis Detail -->
                <div class="p-4 sm:p-8">
                    <h4 class="text-xl font-bold text-white mb-6 flex items-center">
                        <i data-lucide="${iconName}" class="w-5 h-5 mr-2 ${isBadMode ? 'text-red-500' : 'text-amber-500'}"></i>
                        ${isBadMode ? '악연 정밀 분석' : '상세 풀이'}
                    </h4>
                    
                    ${personalitySection}
                    ${analysisItems}
                    ${adviceSection}
                </div>
            </div>`;
            
            // Re-render icons for new content
            lucide.createIcons();
            
            // Scroll to result
            container.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // --- INIT ---
        window.addEventListener('DOMContentLoaded', () => {
            renderTabs();
            lucide.createIcons();
            
            // Add listeners for real-time card updates
            ['A', 'B'].forEach(p => {
                document.getElementById(`date${p}`).addEventListener('change', () => updateSajuCard(p));
                document.getElementById(`time${p}`).addEventListener('change', () => updateSajuCard(p));
                document.getElementById(`name${p}`).addEventListener('input', () => updateSajuCard(p));
            });
        });

    </script>
</body>
</html>